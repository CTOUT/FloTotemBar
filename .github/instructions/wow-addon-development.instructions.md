---
description: 'AscensionVanity project-specific WoW addon development patterns and standards'
applyTo: '**/*.{lua,toc,xml,ps1,md}'
---

# AscensionVanity Project Instructions

**Version**: 2.0.0  
**Last Updated**: November 5, 2025

## üìã When to Use This File

**Use this file for:**
- ‚úÖ AscensionVanity-specific patterns and workflows
- ‚úÖ Project file structure and load order
- ‚úÖ Project-specific gotchas and solutions
- ‚úÖ Data processing pipelines for this project
- ‚úÖ AscensionVanity discoveries and insights

**Use OTHER files for:**
- üìò **Main Instructions** (`copilot-instructions.md`): Project philosophy, architecture, high-level workflows
- üìô **Chatmode** (`wow-addon-development.chatmode.md`): General WoW API knowledge, Lua 5.1 patterns, performance optimization

---

## üéØ Project Context

This is **AscensionVanity** - a World of Warcraft addon for Project Ascension that displays vanity item (combat pets) drop information in creature tooltips.

**Project Fundamentals:**
- Data flow: Game ‚Üí Lua ‚Üí JSON ‚Üí PowerShell enrichment ‚Üí Lua  
- Consolidation philosophy: Extend, don't duplicate
- File structure: Strict load order enforced by TOC
- Database: 2,343 combat pets, 99.95% coverage

## üö´ Do NOT Search For These Topics

**This project uses ONLY:**
- ‚úÖ Lua 5.1 (WoW addon code)
- ‚úÖ PowerShell 7+ (data processing)
- ‚úÖ WoW API (classic/WOTLK/Project Ascension)
- ‚úÖ JSON (data interchange)

**NEVER search for:**
- ‚ùå Azure, AWS, or cloud services
- ‚ùå Entra ID, OAuth, or identity systems
- ‚ùå Modern JavaScript frameworks
- ‚ùå Docker, Kubernetes, or containerization
- ‚ùå .NET Core, ASP.NET (we use PowerShell, not C# )
- ‚ùå React, Vue, Angular
- ‚ùå SQL databases (we use Lua tables and JSON files)

## üìÅ Project File Structure

```
AscensionVanity/
‚îú‚îÄ‚îÄ AscensionVanity.toc          # CRITICAL: Load order defined here
‚îú‚îÄ‚îÄ VanityDB.lua                 # Generated - DO NOT EDIT MANUALLY
‚îú‚îÄ‚îÄ VanityDB_Loader.lua          # Database loading and initialization
‚îú‚îÄ‚îÄ Core.lua                     # Main addon logic and tooltip handling
‚îú‚îÄ‚îÄ AscensionVanityConfig.lua    # Configuration and settings
‚îú‚îÄ‚îÄ APIScanner.lua               # In-game data collection
‚îî‚îÄ‚îÄ ScannerUI.lua                # Scanner interface components

data/
‚îú‚îÄ‚îÄ API_to_GameID_Mapping.json   # Source of truth - EDIT THIS
‚îú‚îÄ‚îÄ VanityDB.lua                 # Generated output
‚îî‚îÄ‚îÄ [Various analysis files]      # Generated by scripts

utilities/
‚îú‚îÄ‚îÄ MasterDescriptionEnrichment.ps1  # MASTER enrichment workflow
‚îú‚îÄ‚îÄ GenerateVanityDB.ps1             # JSON ‚Üí Lua conversion
‚îî‚îÄ‚îÄ [Other helper scripts]
```

## üîë Critical Project Patterns

### Load Order is Sacred
**From AscensionVanity.toc:**
```toc
VanityDB.lua           # 1. Defines globals first
VanityDB_Loader.lua    # 2. Loads and processes database
Core.lua               # 3. Main logic (depends on DB)
AscensionVanityConfig.lua
APIScanner.lua
ScannerUI.lua
```

**NEVER change load order without explicit user approval.**

### Global Namespace Convention
```lua
-- All globals MUST use AV_ prefix
AV_VanityItems = {}    -- Main database
AV_IconList = {}       -- Shared icon references
AV_Config = {}         -- Configuration

-- Local variables: camelCase
local vanityDB = AV_VanityItems
local itemCount = 0
```

### Database Structure
```lua
AV_VanityItems = {
    ["Creature Name"] = {
        type = "Beast",  -- Creature family
        items = {
            {
                name = "Foo's Collar",
                pet = "Foo",
                icon = 1,  -- Index into AV_IconList
                desc = "Drops from Creature in Zone"
            }
        }
    }
}

AV_IconList = {
    [1] = "Interface\\Icons\\INV_Box_PetCarrier_01",
    -- Deduplicated icon paths
}
```

### Consolidation Philosophy
**From copilot-instructions.md:**
> "Innovate, Don't Reinvent - Consolidate over create new files"

**Before creating a new script:**
1. Can this be added to an existing script?
2. Is there a master workflow that handles this?
3. Check `utilities/` for existing tools
4. Ask user before creating new files

### Data Processing Workflow
```
1. Game Client (APIScanner) ‚Üí Export Lua table
2. Transform to JSON (API_to_GameID_Mapping.json)
3. Enrich with descriptions (MasterDescriptionEnrichment.ps1)
4. Generate VanityDB.lua (GenerateVanityDB.ps1)
5. Load in-game (VanityDB_Loader.lua)
```

## üéØ Project-Specific Standards

### When Editing Addon Code (Lua)

```lua
-- ‚úÖ GOOD: Follow established patterns
function AV_GetVanityItems(creatureName, creatureType)
    local items = AV_VanityItems[creatureName]
    if not items then return nil end
    return items
end

-- ‚ùå BAD: Don't use different patterns
function GetItems(name)  -- Missing AV_ prefix
    return VanityItems[name]  -- Wrong global name
end
```

### When Editing Data Scripts (PowerShell)

```powershell
# ‚úÖ GOOD: Use master workflows
.\utilities\MasterDescriptionEnrichment.ps1
.\utilities\GenerateVanityDB.ps1

# ‚ùå BAD: Don't create one-off scripts
.\utilities\FixOneThing.ps1
.\utilities\UpdateOneItem.ps1
```

### When Adding New Features

1. **Discuss with user first** - Avoid scope creep
2. **Check copilot-instructions.md** - Follow existing patterns
3. **Minimize file changes** - Surgical modifications only
4. **Test data flow** - Game ‚Üí JSON ‚Üí Lua ‚Üí Game
5. **Update documentation** - Keep docs current

## üîÑ Self-Improvement Protocol

### Document New Discoveries

When you discover a new pattern specific to this project:

```markdown
### Pattern: [Name]
**Discovered**: [Date]
**Files Affected**: [List]
**Description**: [What it does]
**Implementation**: [Code example]
```

### Track Project-Specific Gotchas

When you encounter a project-specific issue:

```markdown
### Gotcha: [Issue Name]
**Date**: [Date]
**Problem**: [What went wrong]
**Solution**: [How to avoid/fix]
**Files**: [Related files]
```

## üìñ Discovered Project Patterns

### Pattern: Icon Deduplication
**Discovered**: During v2.0 development
**Files**: VanityDB.lua, GenerateVanityDB.ps1
**Description**: Icons are stored in a separate array and referenced by index to save memory
**Implementation**:
```lua
AV_IconList = { [1] = "path1", [2] = "path2" }
items = { { icon = 1 } }  -- Reference by index
```

### Pattern: Master Script Consolidation
**Discovered**: v2.0 cleanup
**Files**: utilities/MasterDescriptionEnrichment.ps1
**Description**: Single master script handles entire enrichment workflow instead of multiple fragmented scripts
**Implementation**: See `utilities/MasterDescriptionEnrichment.ps1`

### Pattern: Group ID Based Filtering (Nov 2025)
**Discovered**: November 2025 during v2.1 development
**Files**: utilities/MasterVanityDBPipeline.ps1
**Description**: All dropped combat pets use exactly 5 Group IDs, providing 100% coverage
**Group IDs**:
- 16777217 - Beastmaster's Whistle (910 items, 99.1% clean)
- 16777220 - Blood Soaked Vellum (564 items, 96.6% clean)
- 16777218 - Summoner's Stone (271 items, 98.5% clean)
- 16777224 - Draconic Warhorn (315 items, 100% clean)
- 16777232 - Elemental Lodestone (283 items, 98.9% clean)
**Outliers**: 10 seasonal reward pets (Groups: 553648129, 553648130, 553648136) correctly excluded by keyword filters
**Verification**: No dropped combat pets exist outside these 5 primary Group IDs
**Implementation**: Primary filter uses Group ID check for performance, fallback uses name prefix + keyword exclusion

### Pattern: Immutable Source + Layered Corrections (Nov 2025)
**Discovered**: November 2, 2025
**Files**: data/sources/, data/corrections/, utilities/MasterPipeline.ps1
**Description**: Data integrity infrastructure that prevents corruption through immutable sources and documented corrections
**Structure**:
```
data/
‚îú‚îÄ‚îÄ sources/      # IMMUTABLE - never edit (checksums verify)
‚îú‚îÄ‚îÄ corrections/  # VERSION CONTROLLED - manual fixes
‚îî‚îÄ‚îÄ processed/    # GENERATED - intermediate files
```
**Benefits**:
- Source files stay pristine (can regenerate anytime)
- All corrections documented with reason and verification
- Reproducible pipeline from source to final database
- Checksums detect file tampering
**Implementation**: See `docs/DATA_INTEGRITY_IMPLEMENTATION.md` and `data/README.md`

### Pattern: Lua String Escaping Round-Trip (Nov 2025)
**Discovered**: November 7, 2025
**Files**: utilities/MasterAPIDumpImport.ps1, utilities/GenerateVanityDB_Master.ps1
**Description**: Proper handling of special characters (quotes, backslashes) through the data pipeline
**Flow**:
```
Game Lua ‚Üí Import (unescape) ‚Üí JSON ‚Üí Generate (escape) ‚Üí Lua
"Maury \"Club Foot\" Wilkins"  ‚Üí  Maury "Club Foot" Wilkins  ‚Üí  "Maury \"Club Foot\" Wilkins"
```
**Implementation**:
```powershell
# IMPORT (MasterAPIDumpImport.ps1)
# 1. Capture with regex that handles escapes
if ($block -match '\["name"\]\s*=\s*"((?:[^"\\]|\\.)*)"') {
    $name = $Matches[1]
    # 2. Unescape Lua strings
    $name = $name -replace '\\"', '"'
}

# GENERATE (GenerateVanityDB_Master.ps1)
# 1. Escape backslashes first (order matters!)
$safeName = $name -replace '\\', '\\\\' -replace '"', '\"'
```
**Critical**: Must maintain BOTH import unescape AND generation escape. Missing either breaks items with quotes.
**Test Items**: Count Ungula (79631), Maury "Club Foot" Wilkins (87655), Chucky "Ten Thumbs" (87657)
**Verification**: Run `.\utilities\TestQuoteEscaping.ps1` to verify fix is still in place (10 automated checks)

### Pattern: Automated Regression Testing (Nov 2025)
**Discovered**: November 7, 2025
**Files**: utilities/TestQuoteEscaping.ps1
**Description**: Automated tests prevent critical fixes from being lost during refactoring
**Why Needed**: Quote escaping fix was lost at least 3 times before automated testing was added
**Implementation**: Script tests both source files for correct logic AND output file for correct results
**Usage**:
```powershell
.\utilities\TestQuoteEscaping.ps1  # Should pass all 10 tests
```
**When to Run**:
- Before any deployment to production
- After modifying import or generation scripts
- After "simplifying" or refactoring escaping logic
- When quote-related issues are reported

### Pattern: Triple-Layer Documentation (Nov 2025)
**Discovered**: November 7, 2025
**Files**: Multiple locations
**Description**: Critical fixes that keep getting lost need multiple layers of documentation
**Layers**:
1. **Code Comments**: Explain WHY the complexity exists
2. **Pattern Documentation**: How it works (this file)
3. **Gotcha Warning**: What happens if removed (this file)
4. **Standalone Reference**: Complete explanation with examples (e.g., QUOTE_ESCAPING_FIX.md)
5. **Automated Test**: Catches removal/modification
**When to Apply**: When a fix has been lost/re-implemented 2+ times

---

*Add new patterns here as discovered*

## ‚ö†Ô∏è Project-Specific Gotchas

### Gotcha: VanityDB.lua is Generated
**Problem**: Users might manually edit VanityDB.lua
**Solution**: Always edit `data/API_to_GameID_Mapping.json` instead, then regenerate
**Files**: VanityDB.lua (output), API_to_GameID_Mapping.json (source)

### Gotcha: Load Order Dependencies
**Problem**: Scripts fail if files load in wrong order
**Solution**: TOC file defines strict load order. VanityDB.lua MUST load first.
**Files**: AscensionVanity.toc

### Gotcha: Global Namespace Pollution
**Problem**: Variables without AV_ prefix can conflict with other addons
**Solution**: ALWAYS use AV_ prefix for globals, local for everything else
**Files**: All .lua files

### Gotcha: Group ID Coverage Assumption
**Problem**: Assuming there might be dropped combat pets outside the 5 primary Group IDs
**Solution**: Comprehensive analysis confirms 100% coverage - all dropped combat pets use one of the 5 Group IDs (16777217, 16777220, 16777218, 16777224, 16777232)
**Verification**: 10 seasonal reward outliers (different Group IDs) are correctly excluded via keyword filters
**Files**: MasterVanityDBPipeline.ps1, copilot-instructions.md
**Date Verified**: November 2025

### Gotcha: Manual Edits to Source Files Cause Corruption
**Problem**: Manually editing `API_to_GameID_Mapping.json` to fix creature IDs led to accidental name corruption
**Solution**: Never edit source files directly. Use `data/corrections/CreatureIdCorrections.json` instead
**Evidence**: Item 79582 (Prairie Stalker) had creature ID 98766 in game data, manual edit corrupted the name
**Fix**: Implemented immutable source + corrections infrastructure (Nov 2, 2025)
**Files**: data/sources/ (immutable), data/corrections/ (for fixes), utilities/MasterPipeline.ps1
**Prevention**: Checksums detect tampering, corrections are documented and version controlled

### Gotcha: Quote Escaping Must Be Maintained in Pipeline (CRITICAL - Fixed Multiple Times!)
**Date**: November 7, 2025 (Fixed previously at least 3 times!)
**Problem**: Names/descriptions with quotes (e.g., Maury "Club Foot" Wilkins, Chucky "Ten Thumbs", "Count" Ungula) cause Lua syntax errors in-game due to improper escaping
**Root Cause**: Two-step process requires both proper UNESCAPING on import and proper ESCAPING on generation
**Solution**: 
1. **MasterAPIDumpImport.ps1** (lines 221-230):
   - Use regex `((?:[^"\\]|\\.)*)` to capture escaped quotes in Lua strings
   - Unescape with `-replace '\\"', '"'` to convert Lua `\"` back to plain `"`
   - Apply to BOTH names and descriptions
2. **GenerateVanityDB_Master.ps1** (line 277):
   - Escape backslashes first: `-replace '\\', '\\\\'` (double each backslash)
   - Then escape quotes: `-replace '"', '\"'` (escape each quote)
   - Apply to names, descriptions, zones, subzones, and quest lock fields
**Test**: Round-trip test: `Maury "Club Foot" Wilkins` ‚Üí Lua `\"` ‚Üí JSON ‚Üí back to plain `"` ‚Üí Lua `\"`
**Files**: utilities/MasterAPIDumpImport.ps1, utilities/GenerateVanityDB_Master.ps1
**Affected Items**: Count Ungula (79631), Maury "Club Foot" Wilkins (87655), Chucky "Ten Thumbs" (87657)
**‚ö†Ô∏è CRITICAL**: This fix has been lost multiple times. DO NOT remove or "simplify" the escaping logic without testing these specific items!

### Gotcha: Database Structure Changed in V2.2+ (CRITICAL!)
**Date**: November 10, 2025
**Problem**: Drop celebration not firing! `IsVanityItem()` returning false for ALL items!
**Root Cause**: Code was searching **V2.1 database structure** (nested by creature name) but V2.2+ uses **flat structure keyed by itemId**
**Old Structure (V2.1)**:
```lua
AV_VanityItems = {
    ["Creature Name"] = {
        type = "Beast",
        items = { {id=123, name="..."}, ... }
    }
}
```
**New Structure (V2.2+)**:
```lua
AV_VanityItems = {
    [123] = { name="...", creatureId=456, ... },  -- Keyed by itemId!
    [124] = { name="...", creatureId=789, ... }
}
```
**Fix**: Change from nested loop search to direct key lookup:
```lua
-- OLD (V2.1 - WRONG!)
for creatureName, creatureData in pairs(AV_VanityItems) do
    for _, item in ipairs(creatureData.items) do
        if item.id == itemId then return true end
    end
end

-- NEW (V2.2+ - CORRECT!)
return AV_VanityItems[itemId] ~= nil
```
**Files Affected**: StatisticsTracker.lua (`IsVanityItem`, `GetItemCategory`)
**Impact**: Without this fix, NO vanity drops are detected ‚Üí NO celebration, NO stats tracking!
**‚ö†Ô∏è CRITICAL**: Always check database structure version when accessing AV_VanityItems! Use `AV_GetItemData(itemId)` from VanityDB_Loader for safe access.

---

*Add new gotchas here as discovered*

## üéØ Quick Decision Guide

### Should I create a new file?
```
‚îå‚îÄ Is there an existing file that does similar work?
‚îÇ  ‚îú‚îÄ YES ‚Üí Extend existing file
‚îÇ  ‚îî‚îÄ NO ‚Üì
‚îú‚îÄ Is this a one-time task?
‚îÇ  ‚îú‚îÄ YES ‚Üí Ask user if manual is okay
‚îÇ  ‚îî‚îÄ NO ‚Üì
‚îú‚îÄ Will this be used repeatedly?
‚îÇ  ‚îú‚îÄ YES ‚Üí Create new file (with user approval)
‚îÇ  ‚îî‚îÄ NO ‚Üí Don't create file
```

### Should I search for documentation?
```
‚îå‚îÄ Is this about WoW API or Lua 5.1?
‚îÇ  ‚îú‚îÄ YES ‚Üí Search wowpedia/wowwiki
‚îÇ  ‚îî‚îÄ NO ‚Üì
‚îú‚îÄ Is this about PowerShell?
‚îÇ  ‚îú‚îÄ YES ‚Üí Search PowerShell docs
‚îÇ  ‚îî‚îÄ NO ‚Üì
‚îú‚îÄ Is this about Azure/Entra/Cloud?
‚îÇ  ‚îî‚îÄ NO ‚Üí STOP - Out of scope!
‚îî‚îÄ Is this about this specific project?
   ‚îî‚îÄ YES ‚Üí Check .github/copilot-instructions.md
```

## üöÄ Common Tasks

### Task: Add New Vanity Items
1. Edit `data/API_to_GameID_Mapping.json`
2. Run `MasterDescriptionEnrichment.ps1` (enriches descriptions)
3. Run `GenerateVanityDB.ps1` (regenerates VanityDB.lua)
4. Test in-game with `/reload`

### Task: Fix Item Description
1. Find item in `data/API_to_GameID_Mapping.json`
2. Update description field
3. Run `GenerateVanityDB.ps1`
4. Test in-game

### Task: Modify Tooltip Behavior
1. Edit `Core.lua` (tooltip logic lives here)
2. Test in-game with `/reload`
3. Check for Lua errors (`/console scriptErrors 1`)

### Task: Add New Configuration Option
1. Add to `AscensionVanityConfig.lua`
2. Add UI in `SettingsUI.lua` (if needed)
3. Reference in `Core.lua` where used
4. Test with saved variables (`WTF/Account/.../SavedVariables/`)

### Task: Fix Creature ID Issues
1. **Never edit** `data/sources/API_to_GameID_Mapping.json` directly
2. Add correction to `data/corrections/CreatureIdCorrections.json`:
   ```json
   {
     "itemId": 79582,
     "itemName": "Beastmaster's Whistle: Prairie Stalker",
     "wrongCreatureId": 98766,
     "correctCreatureId": 2959,
     "reason": "High ID doesn't exist, verified via db.ascension.gg",
     "verifiedBy": "https://db.ascension.gg/?item=79582",
     "dateAdded": "2025-11-02"
   }
   ```
3. Run `.\utilities\MasterPipeline.ps1 -SkipExtract`
4. Test in-game with `/reload`

### Pattern: Master Restoration Workflow
**Discovered**: 2025-11-01
**Purpose**: Safely rebuild full `VanityDB.lua` after partial generation or data loss.
**Steps**:
1. Parse latest filtered scan (`AscensionVanity_Fresh_Scan_*_FINAL.lua`).
2. Overlay mapping corrections (`API_to_GameID_Mapping.json`).
3. Merge validated/enriched descriptions (`EmptyDescriptions_Validated.json`, enrichment CSV outputs).
4. Generate `MasterFullValidated.json` (single source). 
5. Run master generator (`GenerateVanityDB_Master.ps1`) with dedupe protection.
6. Validate (`ValidateCreatureIds.ps1 -All`) then triage anomalies.

### Pattern: Multi-Source Enrichment Overlay
**Discovered**: 2025-11-01
**Description**: Combine enrichment sources before DB generation to prevent description regression.
**Sources**:
- Validated subset JSON (region-aware generated descriptions)
- Enrichment CSV (future extended sources)
- Mapping names for authoritative corrections
**Rule**: Never emit final DB with placeholder or null descriptions when enriched info exists in any source.

### Pattern: Structured Anomaly Triage
**Discovered**: 2025-11-01
**Files**: `GenerateAnomalyTriage.ps1`, validation CSV/JSON
**Outputs**:
- `vendor_candidates.json`: Items likely vendor/event (set CreatureId = 0) & suppress in tooltip.
- `prefix_strip_candidates.json`: High/extreme IDs with `400` prefix and no evidence (apply prefix-stripping heuristic).
- `manual_review_highrange.json`: Remaining high/extreme outliers requiring manual research.
**Loop**: Correct ‚Üí regenerate ‚Üí revalidate until only legitimate custom IDs remain.

### Gotcha: Partial Source Regression
**Problem**: Generating from a limited validated subset collapses DB from ~2000 items to <100.
**Solution**: Use master workflow; never replace full dataset with subset file. Preserve full scan artifacts.
**Indicator**: Item count drastically lower than expected baseline (~2100+).

---

**Result:**
- ‚úÖ Clean code with no false warnings
- ‚úÖ IntelliSense for WoW API
- ‚úÖ Autocomplete for addon globals
- ‚úÖ No need for AddOn Studio

---

## üéØ Common Tasks

### Task: Add New Configuration Option

1. Add to `AscensionVanityConfig.lua`
2. Add UI in `SettingsUI.lua` (if needed)
3. Reference in `Core.lua` where used
4. Test with saved variables (`WTF/Account/.../SavedVariables/`)

## üêõ Debugging Checklist

When something doesn't work in-game:

**1. Lua Errors**
- [ ] Enable errors: `/console scriptErrors 1`
- [ ] Check for red error popup on screen
- [ ] Review error message for file name and line number
- [ ] Check Lua syntax in reported file

**2. Load Order Issues**
- [ ] Check `AscensionVanity.toc` file order
- [ ] Ensure `VanityDB.lua` loads FIRST (defines globals)
- [ ] Ensure `VanityDB_Loader.lua` loads SECOND (uses globals)
- [ ] Verify no circular dependencies between files

**3. Data Issues**
- [ ] Validate `data/API_to_GameID_Mapping.json` format (valid JSON)
- [ ] Regenerate `VanityDB.lua` with latest script version
- [ ] Verify database loaded: `/dump AV_VanityItems`
- [ ] Check for nil values: `/dump AV_VanityItems["CreatureName"]`

**4. SavedVariables Issues**
- [ ] Locate file: `WTF/Account/[ACCOUNT]/SavedVariables/AscensionVanity.lua`
- [ ] Delete SavedVariables file to reset to defaults
- [ ] `/reload` to regenerate with fresh defaults
- [ ] Check for nil value errors in configuration

**5. Performance Issues**
- [ ] Use `/framestack` to check frame rates (should be 60+ FPS)
- [ ] Profile with `debugprofilestop()` in code
- [ ] Look for excessive event registrations (use `/etrace`)
- [ ] Check for memory leaks (unregistered events, dangling references)

**6. Tooltip Issues**
- [ ] Verify tooltip hook is registered: `/dump GameTooltip:GetScript("OnTooltipSetUnit")`
- [ ] Check creature name matching (case-sensitive!)
- [ ] Verify `AV_VanityItems[creatureName]` returns data
- [ ] Test with known creatures that have vanity items

## ÔøΩüìö Key Files Reference

### copilot-instructions.md
**Purpose**: Master project documentation
**When to reference**: Before making ANY significant changes
**Key sections**: 
- Core Philosophy
- Project Architecture  
- Coding Standards
- Common Tasks

### VanityDB.lua
**Purpose**: In-game database (GENERATED)
**Edit?**: NEVER directly - regenerate via script
**Used by**: VanityDB_Loader.lua, Core.lua

### Core.lua
**Purpose**: Main addon logic, tooltip integration
**Edit?**: YES - most feature changes happen here
**Depends on**: VanityDB.lua (must load first)

### MasterDescriptionEnrichment.ps1
**Purpose**: Fetch descriptions from db.ascension.gg and Wowhead
**Edit?**: YES - this is the master enrichment workflow
**Outputs**: Enriched JSON, reports, manual research list

---

## üö® When Copilot Gets It Wrong

If I suggest something that contradicts these instructions:
1. **Point it out immediately** - "That contradicts the [section] rule"
2. **Reference the rule** - Quote the specific instruction I violated
3. **I will correct** - Acknowledge and provide the right approach
4. **Document it** - Add to "Gotchas" section for future reference

**Common project-specific mistakes to watch for:**
- Suggesting manual edits to VanityDB.lua (it's generated - edit JSON instead!)
- Creating new utility scripts instead of extending master scripts
- Searching for Azure/Entra docs for this WoW addon project
- Missing the critical TOC load order (VanityDB.lua must be first!)
- Proposing .NET/C# solutions instead of PowerShell for data processing
- Ignoring the consolidation philosophy (extend, don't duplicate)

---

## üìú Version History

### v1.2.0 - November 2, 2025
- Added data integrity infrastructure pattern (immutable sources + corrections)
- Added creature ID correction workflow task
- Added manual source edit corruption gotcha
- Added periodic maintenance protocol
- Expanded discovered patterns with layered corrections approach
- Added maintenance checklist for repository housekeeping

### v1.3.0 - November 3, 2025
- Added VS Code extensions section
- Documented required extensions for WoW development
- Added workspace configuration details
- Created VSCODE_EXTENSIONS.md reference
- Added development environment discovery to Recent Insights

### v1.2.0 - November 2, 2025
- Added data integrity infrastructure pattern (immutable sources + corrections)
- Added creature ID correction workflow task
- Added manual source edit corruption gotcha
- Added periodic maintenance protocol
- Expanded discovered patterns with layered corrections approach
- Added maintenance checklist for repository housekeeping

### v1.1.0 - October 31, 2025
- Added cross-reference links to global chatmode and main instructions
- Added comprehensive debugging checklist
- Added "When Copilot Gets It Wrong" protocol
- Added version history tracking
- Expanded common tasks with more detail

### v1.0.0 - October 31, 2025
- Initial creation with project-specific patterns
- Established file structure and load order documentation
- Created project-specific gotchas tracking
- Defined decision guides and quick references

## üßπ Periodic Maintenance Tasks

**Frequency**: After every major feature completion or significant work session

### 1. Repository Housekeeping
```powershell
# Check for uncommitted changes
git status

# Review unstaged files
git diff

# Check branch status
git branch -vv
```

**Actions:**
- Review all unstaged/uncommitted files
- Decide: commit, archive, or delete
- Clean up temporary/test files
- Update .gitignore if needed

### 2. File Consolidation

**Documentation Files:**
- Review docs/ folder for outdated/duplicate files
- Consolidate overlapping documentation
- Archive superseded documents to docs/archived/
- Update cross-references and links

**Script Files:**
- Check utilities/ for one-off scripts that should be consolidated
- Move obsolete scripts to utilities/archive/
- Update master workflows to incorporate useful one-offs
- Document any new master scripts in copilot-instructions.md

**Data Files:**
- Clean up data/processed/ (regenerated files)
- Backup important analysis to data/backups/
- Clear data/triage/ of old reports
- Verify data/corrections/ is committed

### 3. GitHub Commits

**Commit Strategy:**
- Group related changes into logical commits
- Use conventional commit format:
  - `feat:` New features
  - `fix:` Bug fixes
  - `refactor:` Code restructuring
  - `docs:` Documentation only
  - `chore:` Maintenance tasks
  - `perf:` Performance improvements

**Example Workflow:**
```powershell
# Stage related files
git add utilities/NewScript.ps1
git add docs/NEW_FEATURE.md

# Commit with descriptive message
git commit -m "feat: add automated anomaly detection for creature IDs

- New script validates creature ID ranges
- Generates triage reports for manual review
- Integrates with MasterPipeline.ps1

Resolves issue with high ID outliers"

# Push to remote
git push origin v2.1-dev
```

### 4. Update Instruction Files

**After discovering new patterns:**
1. Add to "Discovered Project Patterns" section
2. Include date, files affected, description
3. Provide code example if applicable

**After encountering gotchas:**
1. Add to "Project-Specific Gotchas" section
2. Document problem, solution, and prevention
3. Reference related files

**After creating new workflows:**
1. Add to "Common Tasks" section
2. Provide step-by-step instructions
3. Include example commands

### 5. Maintenance Checklist

- [ ] All working files committed to git
- [ ] Obsolete scripts moved to archive/
- [ ] Documentation updated and consolidated
- [ ] Instruction files reflect new discoveries
- [ ] Data integrity verified (checksums)
- [ ] Branch pushed to GitHub
- [ ] Clean working directory (`git status` clean)

**Pro Tip**: Run this checklist before ending each work session to keep the repository clean and maintainable.

---

## üîÑ Recent Discoveries & Insights (Auto-Updated)

**Last Updated**: November 7, 2025

This section is periodically updated by Copilot with new insights, challenges, and recognitions to prevent reinventing the wheel.

### November 7, 2025 - Quote Escaping Fix Made Permanent

**Challenge**: Items with quotes in names (Count Ungula, Maury "Club Foot" Wilkins, Chucky "Ten Thumbs") were causing Lua syntax errors. This issue had been fixed at least 3 times before and kept getting lost during refactoring.

**Solution**: Implemented comprehensive protection system:
1. **Code Fix**: Proper unescape on import (MasterAPIDumpImport.ps1) + proper escape on generation (GenerateVanityDB_Master.ps1)
2. **Automated Test**: TestQuoteEscaping.ps1 with 10 validation checks
3. **Triple Documentation**: Pattern + Gotcha warning + Standalone reference (QUOTE_ESCAPING_FIX.md)
4. **Explicit Warning**: Documentation states "Fixed Multiple Times" to alert future developers

**Insight**: Critical fixes that keep getting lost need MULTIPLE layers of protection:
- Automated tests (catches removal)
- Clear documentation (explains why complexity is needed)
- Warning messages (prevents "simplification")
- Standalone reference (provides complete context)

**Result**: Fix committed (0f79246) with comprehensive safeguards. Will not be lost again.

### November 2, 2025 - Data Structure Consistency

**Insight**: Field name inconsistencies were causing frequent nil value errors and wasted time guessing correct field names.

**Solution**: Created comprehensive schema documentation in `docs/DATA_SCHEMAS.md` that defines:
- All Lua structures (AscensionVanityDB, AscensionVanityDump, VanityDB.lua)
- All JSON structures (API_to_GameID_Mapping.json, MasterFullValidated.json)
- PowerShell objects used in processing
- Category naming conventions (beast/demon/undead/dragonkin/elemental)
- Common field name mistakes and corrections

**Action**: ALWAYS reference `docs/DATA_SCHEMAS.md` before accessing fields in any data structure.

### November 2, 2025 - Category Filter Naming

**Challenge**: Inconsistent category names across systems caused confusion:
- Old scan data had `totem` and `pet` in SavedVariables
- Generation scripts used `Beast`, `Demon`, etc.
- Config file had mixed naming

**Solution**: Standardized naming convention:
- **Lua config keys**: lowercase (`beast`, `demon`, `undead`, `dragonkin`, `elemental`)
- **JSON fields**: PascalCase (`"Beast"`, `"Demon"`, `"Undead"`, `"Dragonkin"`, `"Elemental"`)
- **Group ID mappings**: Documented in DATA_SCHEMAS.md

**Recognition**: User caught this inconsistency - configuration should match generation naming exactly!

### November 2, 2025 - APIDump Field Ordering

**Observation**: Large APIDump dictionary in middle of metadata made scan files hard to read.

**Solution**: Reordered AscensionVanityDump fields:
- Metadata fields sorted alphabetically
- APIDump comes LAST for easier human readability
- Updated APIScanner.lua to enforce this order

**Pattern**: For large nested structures, place them at the end of parent structures for better readability.

### November 2, 2025 - Icon List Filtering

**Challenge**: Initial icon list generation included all 3,727 icons from scan data, not just combat pets.

**Solution**: Filter icons by Group ID during generation:
- Only extract icons from items with Group IDs: 16777217, 16777220, 16777218, 16777224, 16777232
- Read from `AscensionVanityDump["APIDump"]` section (skip SavedVariables at top)
- Result: 14 unique icons instead of 3,727

**Lesson**: Always filter data at the earliest possible stage to prevent scope creep.

### November 3, 2025 - VS Code Development Environment

**Insight**: Professional WoW addon development doesn't require AddOn Studio - VS Code with proper extensions is superior.

**Solution**: Installed and configured 4 essential extensions:
- sumneko.lua - Best Lua Language Server available
- ketho.wow-api - WOTLK 3.3.5 API annotations
- septh.wow-bundle - WoW-specific toolset
- stanzilla.vscode-wow-toc - TOC file support

**Configuration**: Created `.vscode/settings.json` with:
- Lua 5.1 runtime (WOTLK era)
- All AscensionVanity globals declared (no false warnings)
- WoW API annotations enabled
- Built-in Lua libraries disabled (WoW has its own)

**Benefits**:
- ‚úÖ Full IntelliSense for WoW API functions
- ‚úÖ Autocomplete for addon-specific globals
- ‚úÖ Real-time error detection (no false positives)
- ‚úÖ Parameter hints on hover
- ‚úÖ TOC file syntax highlighting
- ‚úÖ Lighter weight than AddOn Studio

**Documentation**: Created `docs/VSCODE_EXTENSIONS.md` with setup guide for team members.

**Action**: ALWAYS reference this setup for new team members. Skip AddOn Studio entirely!

---

**Update Protocol**: After each significant work session or discovery, add entries here with date, challenge, solution, and actionable takeaway.

---

## üìú Version History

### v2.1.0 - November 7, 2025
**Critical Fix + Documentation**: Quote escaping fix with permanent protection
- Added Lua String Escaping Round-Trip pattern
- Added Quote Escaping Must Be Maintained gotcha (marked as fixed multiple times)
- Added Automated Regression Testing pattern
- Added Triple-Layer Documentation pattern
- Created TestQuoteEscaping.ps1 with 10 automated validation checks
- Created QUOTE_ESCAPING_FIX.md standalone reference
- Added WoW-specific lessons to chatmode file (Lua string escaping, regex parsing, two-step pipeline)
- Updated Recent Discoveries with November 7, 2025 insights
- Commit: 0f79246

### v2.0.0 - November 5, 2025
**Major Reorganization**: Eliminated duplication, clarified file boundaries
- Removed general WoW API knowledge (belongs in chatmode file)
- Consolidated all project-specific patterns and discoveries here
- Added clear file navigation guide
- Removed VS Code extension details (consolidated to docs/VSCODE_EXTENSIONS.md reference)
- Focused exclusively on AscensionVanity-specific patterns and workflows

### v1.3.0 - November 3, 2025
- Added VS Code development environment section
- Documented required extensions and configuration

### v1.2.0 - November 2, 2025
- Added data integrity patterns
- Added category naming consistency discoveries
- Added icon list filtering patterns

### v1.0.0 - October 31, 2025
- Initial creation
- Project context and file structure
- Common tasks and gotchas

---

**Remember**: This file evolves with the project. When you discover new AscensionVanity-specific patterns or gotchas, document them here. For general WoW API questions, check the chatmode file. For project philosophy, check the main copilot-instructions.md file.
